<template>
	<ClientOnly>
		<!-- Показываем overlay только пока show = true -->
		<div v-if="show" ref="overlayRef" class="preloader-overlay">
			<svg
				viewBox="0 0 200 200"
				xmlns="http://www.w3.org/2000/svg"
				class="preloader-svg"
			>
				<path
					ref="pathRef"
					fill="none"
					stroke="currentColor"
					:stroke-width="strokeWidth"
					stroke-linecap="round"
					stroke-linejoin="round"
					d="m 111.80765,36.526969 c -2.9464,0 -5.33407,2.336825 -7.16287,7.010425 -1.79494,4.639734 -3.0142,10.244344 -3.65766,16.814478 -2.506138,0.270933 -4.775339,1.151566 -6.807339,2.641699 -1.998133,1.456267 -3.572793,3.352775 -4.724259,5.689575 -1.112093,2.224188 -1.686933,4.638149 -1.72496,7.241419 -0.875556,0.738358 -1.824512,1.389318 -2.846854,1.953369 -1.9304,1.049866 -3.657596,1.575097 -5.181596,1.575097 -2.370667,0 -3.979396,-0.778941 -4.826062,-2.336808 3.996266,-0.982133 6.824253,-2.303082 8.48372,-3.962549 1.693333,-1.693333 2.539896,-3.708309 2.539896,-6.045109 0,-1.998133 -0.592852,-3.573309 -1.778186,-4.724776 -1.185333,-1.185333 -2.759992,-1.777669 -4.724259,-1.777669 -2.201333,0 -4.182757,0.592336 -5.943823,1.777669 -0.172396,0.118311 -0.340939,0.24119 -0.505913,0.367936 -0.344297,-0.278923 -0.86975,-0.418579 -1.576648,-0.418579 -2.3368,0 -4.369068,-0.152536 -6.096268,-0.457336 1.659466,-4.6736 2.489253,-8.92371 2.489253,-12.750643 0,-2.709334 -0.643181,-4.842776 -1.930114,-6.400643 -1.253067,-1.557867 -2.963487,-2.336808 -5.130953,-2.336808 -1.761067,0 -3.369796,0.457092 -4.826062,1.371492 -1.4224,0.9144 -2.556743,2.302971 -3.40341,4.165637 -0.8128,1.8288 -1.219564,4.08071 -1.219564,6.756177 0,2.675467 0.525231,5.046361 1.575098,7.112228 1.049866,2.032 2.60775,3.691574 4.673616,4.978507 -1.659466,3.6576 -3.488353,6.722521 -5.486487,9.194788 -1.998133,2.4384 -3.810243,3.657657 -5.435843,3.657657 -1.388534,0 -2.455255,-0.576076 -3.200322,-1.727543 -0.7112,-1.185333 -1.201845,-2.895236 -1.472778,-5.130436 -0.237067,-2.2352 -0.356051,-5.232499 -0.356051,-8.991699 0,-5.520267 0.474386,-11.04048 1.422652,-16.560746 0.06773,-0.3048 0.101803,-0.72834 0.101803,-1.270207 0,-0.9144 -0.254227,-1.591651 -0.762227,-2.031917 -0.474134,-0.474134 -1.236299,-0.711068 -2.286166,-0.711068 -1.253067,0 -2.252166,0.304556 -2.997233,0.914156 -0.7112,0.575733 -1.201845,1.642455 -1.472778,3.200321 -1.151467,6.773334 -2.55733,12.615396 -4.216797,17.526062 -1.659467,4.8768 -3.335817,8.568127 -5.02915,11.07426 -1.659467,2.472267 -3.08159,3.708817 -4.266924,3.708817 -1.3208,0 -2.370745,-1.23655 -3.149678,-3.708817 -0.778933,-2.472267 -1.168404,-5.976987 -1.168404,-10.515121 0,-4.8768 0.507938,-10.787 1.523938,-17.729667 0.06773,-0.677333 0.101802,-1.134426 0.101802,-1.371492 0,-1.185334 -0.288296,-1.997828 -0.86403,-2.438094 -0.541866,-0.440267 -1.320808,-0.660425 -2.336808,-0.660425 -1.354666,0 -2.353766,0.338625 -2.997233,1.015959 -0.6096,0.643466 -1.032623,1.811879 -1.26969,3.505212 -0.880533,5.960533 -1.320849,11.429901 -1.320849,16.408301 0,6.841066 0.829787,12.293658 2.489253,16.357658 1.659466,4.030133 4.114759,6.045109 7.365959,6.045109 2.878667,0 5.588186,-1.439416 8.128186,-4.318083 2.573867,-2.878667 4.876622,-7.264536 6.908622,-13.157336 0.2032,5.317066 1.049764,9.567693 2.539897,12.751159 1.490133,3.1496 3.725267,4.72426 6.705534,4.72426 3.2512,0 6.536279,-1.659574 9.855212,-4.978508 3.3528,-3.3528 6.214856,-7.552064 8.585523,-12.598197 1.827739,0.377152 3.854347,0.580051 6.079732,0.609265 -0.869627,1.899015 -1.30483,3.948025 -1.30483,6.146912 0,3.3528 0.982323,5.994697 2.94659,7.925097 1.964267,1.9304 4.724115,2.895431 8.280115,2.895431 2.607733,0 5.046249,-0.643698 7.315316,-1.930632 0.885948,-0.495088 1.694087,-1.007717 2.424658,-1.53789 0.238529,0.419681 0.514387,0.813842 0.826823,1.182356 1.354666,1.524 3.064569,2.286166 5.130436,2.286166 1.4224,0 2.658951,-0.305073 3.708817,-0.914673 1.083736,-0.6096 2.336547,-1.811565 3.758947,-3.606498 1.35466,3.014133 3.31879,4.521171 5.89266,4.521171 1.6256,0 3.2684,-0.592853 4.92787,-1.778186 0.56052,-0.411818 1.10542,-0.850286 1.63504,-1.316199 0.18199,0.281982 0.382,0.551138 0.59996,0.808219 1.35467,1.524 3.06509,2.286166 5.13095,2.286166 1.4224,0 2.65844,-0.305073 3.7083,-0.914673 1.08374,-0.6096 2.33707,-1.811565 3.75947,-3.606498 1.35466,3.014133 3.31879,4.521171 5.89266,4.521171 1.6256,0 3.26788,-0.592853 4.92735,-1.778186 0.76124,-0.559278 1.49409,-1.16823 2.19831,-1.827279 0.18461,0.454882 0.40003,0.877746 0.64647,1.268656 1.016,1.557867 2.62473,2.336809 4.82607,2.336809 2.13426,0 4.38705,-1.100122 6.75772,-3.300574 0.0999,0.481628 0.21794,0.904499 0.3545,1.268656 0.54187,1.354667 1.45606,2.031918 2.74299,2.031918 1.04987,0 1.81203,-0.271004 2.28616,-0.812871 0.508,-0.575733 0.94832,-1.659231 1.32085,-3.250964 0.508,-2.065867 1.16848,-4.030514 1.98128,-5.89318 0.84666,-1.862667 1.65916,-3.352412 2.43809,-4.470012 0.8128,-1.151466 1.43921,-1.727543 1.87947,-1.727543 0.37254,0 0.55914,0.271004 0.55914,0.81287 0,0.8128 -0.22016,2.286286 -0.66042,4.419886 -0.47414,2.4384 -0.71107,4.131526 -0.71107,5.079793 0,1.896533 0.4398,3.352726 1.32033,4.368726 0.88054,0.982133 2.18471,1.473295 3.91191,1.473295 2.1336,0 4.03011,-0.57556 5.68957,-1.727027 0.70981,-0.482669 1.39891,-1.022256 2.06706,-1.617989 0.21287,0.37525 0.45525,0.72823 0.72709,1.05885 1.25307,1.524 2.92942,2.286166 5.02915,2.286166 0.9144,0 1.82858,-0.236935 2.74298,-0.711068 0.94827,-0.508 1.71044,-1.21932 2.28617,-2.13372 l -0.30489,1.981275 c -5.21547,4.030133 -8.77155,7.416904 -10.66808,10.160103 -1.89654,2.777067 -2.84479,5.367601 -2.84479,7.772135 0,1.7272 0.54201,3.11577 1.62574,4.16564 1.08373,1.08373 2.48908,1.62574 4.21628,1.62574 3.6576,0 6.56998,-2.54021 8.73745,-7.620209 2.20133,-5.046133 3.94582,-11.938141 5.23276,-20.67574 0.13546,-0.948267 0.45731,-2.895621 0.96531,-5.842021 0.7112,-4.3688 1.13422,-7.077802 1.26969,-8.127669 0.0339,-0.237067 0.0506,-0.558916 0.0506,-0.965316 0,-0.745067 -0.18608,-1.236228 -0.55862,-1.473295 -0.33866,-0.270933 -0.93152,-0.406177 -1.77818,-0.406177 -0.84667,0 -1.59154,0.06762 -2.23501,0.203089 -0.16933,-0.745067 -0.38949,-1.253005 -0.66042,-1.523938 -0.23707,-0.3048 -0.72823,-0.457337 -1.4733,-0.457337 -2.3368,0 -4.55516,0.745389 -6.65489,2.235523 -2.06587,1.456266 -3.72492,3.40362 -4.97799,5.84202 -1.2038,2.30999 -1.82956,4.760198 -1.87689,7.35149 -0.68064,0.742367 -1.27413,1.339787 -1.78077,1.792138 -0.9144,0.8128 -1.71063,1.219564 -2.38797,1.219564 -0.98213,0 -1.47278,-0.677767 -1.47278,-2.032434 0,-0.948267 0.32134,-2.895621 0.9648,-5.842021 0.74507,-3.4544 1.11777,-5.841553 1.11777,-7.162353 0,-2.201334 -1.1008,-3.302124 -3.30213,-3.302124 -1.1176,0 -2.35363,0.389471 -3.7083,1.168404 -1.3208,0.778933 -2.6753,2.082589 -4.06383,3.911389 -1.38854,1.8288 -2.64186,4.199694 -3.75946,7.112227 0.13546,-1.490133 0.30477,-2.74346 0.50797,-3.75946 0.2032,-1.016 0.47421,-2.201189 0.81287,-3.555855 0.508,-1.896534 0.76223,-3.115792 0.76223,-3.657658 0,-0.474134 -0.13576,-0.795983 -0.40669,-0.965316 -0.27093,-0.169333 -0.7448,-0.253731 -1.42214,-0.253731 -1.25306,0 -2.23539,0.236934 -2.94659,0.711067 -0.67733,0.440267 -1.16849,1.151587 -1.47329,2.13372 -1.16603,3.687178 -1.78918,7.564991 -1.87017,11.633399 -0.97366,1.117824 -1.7894,1.981282 -2.4474,2.590539 -0.9144,0.846667 -1.67656,1.270207 -2.28616,1.270207 -0.64347,0 -1.10056,-0.271004 -1.3715,-0.81287 -0.27093,-0.541867 -0.40669,-1.320808 -0.40669,-2.336808 0,-1.3208 0.40676,-3.844231 1.21956,-7.569564 0.64347,-3.081867 0.9648,-5.045997 0.9648,-5.892664 0,-1.151467 -0.86334,-1.727026 -2.59054,-1.727026 -1.1176,0 -1.93061,0.202865 -2.43861,0.609265 -0.508,0.4064 -0.91424,1.151789 -1.21904,2.235522 -0.6096,2.065867 -1.11754,4.301001 -1.52394,6.705534 -0.313,1.991793 -0.49465,3.684635 -0.54467,5.07876 -0.97395,1.093516 -1.79142,1.923588 -2.45257,2.490287 -0.94826,0.8128 -1.87974,1.219564 -2.79414,1.219564 -0.7112,0 -1.30354,-0.42354 -1.77767,-1.270207 -0.44027,-0.846666 -0.72856,-2.252013 -0.86403,-4.21628 3.11573,-5.350933 5.6051,-10.56659 7.46776,-15.64659 1.86267,-5.08 2.79415,-9.516715 2.79415,-13.309782 0,-2.675466 -0.49116,-4.673149 -1.4733,-5.993949 -0.94826,-1.3208 -2.15075,-1.981275 -3.60701,-1.981275 -2.9464,0 -5.33356,2.336825 -7.16236,7.010425 -1.79493,4.639734 -3.01419,10.244344 -3.65765,16.814478 -2.50614,0.270933 -4.77534,1.151566 -6.80734,2.641699 -1.99813,1.456267 -3.57279,3.352775 -4.72426,5.689575 -1.15147,2.302933 -1.72754,4.809071 -1.72754,7.518404 0,0.08611 9.8e-4,0.171834 0.003,0.256832 -0.49474,0.512868 -0.93607,0.93508 -1.32343,1.267106 -0.94827,0.8128 -1.87923,1.219564 -2.79363,1.219564 -0.7112,0 -1.30405,-0.42354 -1.77819,-1.270207 -0.44026,-0.846666 -0.72804,-2.252013 -0.86351,-4.21628 3.11573,-5.350933 5.60509,-10.56659 7.46776,-15.64659 1.86267,-5.08 2.79363,-9.516715 2.79363,-13.309782 0,-2.675466 -0.49065,-4.673149 -1.47278,-5.993949 -0.94827,-1.3208 -2.15075,-1.981275 -3.60701,-1.981275 z m -0.55863,4.977991 c 0.3048,0 0.55851,0.355918 0.76171,1.067118 0.23707,0.7112 0.35554,1.7103 0.35554,2.997234 0,5.012266 -1.89651,11.650046 -5.68958,19.913513 0.2032,-4.030134 0.52505,-7.890772 0.96532,-11.582239 0.47413,-3.691467 1.03292,-6.67199 1.67638,-8.941056 0.64347,-2.302934 1.28717,-3.45457 1.93063,-3.45457 z m 25.65373,0 c 0.3048,0 0.55903,0.355918 0.76223,1.067118 0.23707,0.7112 0.35554,1.7103 0.35554,2.997234 0,5.012266 -1.89651,11.650046 -5.68958,19.913513 0.2032,-4.030134 0.52453,-7.890772 0.9648,-11.582239 0.47413,-3.691467 1.03292,-6.67199 1.67638,-8.941056 0.64347,-2.302934 1.28717,-3.45457 1.93063,-3.45457 z m -77.419042,4.673617 c 0.643466,0 1.151404,0.339142 1.523938,1.016475 0.372533,0.643467 0.558622,1.676119 0.558622,3.098519 0,2.472267 -0.660475,5.604809 -1.981275,9.397876 -2.1336,-1.591733 -3.200321,-4.047025 -3.200321,-7.365959 0,-1.964266 0.28778,-3.471304 0.863513,-4.521171 0.575734,-1.083733 1.321123,-1.62574 2.235523,-1.62574 z m 87.985322,3.149678 c -1.38853,0 -2.55694,0.406764 -3.50521,1.219564 -0.9144,0.778933 -1.37149,1.76074 -1.37149,2.946073 0,1.185334 0.3554,2.116812 1.0666,2.794145 0.7112,0.643467 1.77844,0.965316 3.20084,0.965316 1.45627,0 2.62468,-0.389471 3.50521,-1.168404 0.88054,-0.8128 1.32033,-1.896815 1.32033,-3.251481 0,-1.1176 -0.38947,-1.98094 -1.1684,-2.59054 -0.77893,-0.6096 -1.79481,-0.914673 -3.04788,-0.914673 z m 43.89138,15.900322 -1.62574,8.686808 c -0.3048,1.761067 -0.81274,3.116085 -1.52394,4.064351 -0.7112,0.948267 -1.45607,1.422136 -2.235,1.422136 -0.74507,0 -1.33792,-0.253711 -1.77819,-0.761711 -0.4064,-0.508 -0.60978,-1.286941 -0.60978,-2.336808 0,-1.896533 0.35592,-3.691868 1.06712,-5.385201 0.7112,-1.693333 1.65945,-3.047835 2.84479,-4.063835 1.18533,-1.049866 2.47221,-1.591874 3.86074,-1.62574 z m -112.826702,0.35605 c 0.6096,0 1.083468,0.202865 1.422135,0.609265 0.372533,0.372534 0.559139,0.880472 0.559139,1.523938 0,1.253067 -0.576076,2.353858 -1.727543,3.302124 -1.151467,0.948267 -2.726126,1.659587 -4.724259,2.13372 v -0.101802 c 0,-2.065867 0.42354,-3.826615 1.270206,-5.282882 0.880534,-1.456267 1.947255,-2.184363 3.200322,-2.184363 z m 22.047232,0 c -0.0677,1.8288 -0.1018,3.149232 -0.1018,3.962032 0,2.269067 0.16931,4.318112 0.50798,6.146912 -0.98214,1.4224 -1.79463,2.404723 -2.438097,2.94659 -0.643466,0.508 -1.287164,0.761711 -1.930631,0.761711 -1.693333,0 -2.539897,-1.236034 -2.539897,-3.708301 0,-2.3368 0.609629,-4.453467 1.828829,-6.35 1.253067,-1.9304 2.810948,-3.18321 4.673616,-3.758944 z m 25.65373,0 c -0.0677,1.8288 -0.10128,3.149232 -0.10128,3.962032 0,2.269067 0.16931,4.318112 0.50798,6.146912 -0.98214,1.4224 -1.79515,2.404723 -2.43862,2.94659 -0.64346,0.508 -1.28716,0.761711 -1.93063,0.761711 -1.69333,0 -2.53989,-1.236034 -2.53989,-3.708301 0,-2.3368 0.60963,-4.453467 1.82883,-6.35 1.25306,-1.9304 2.81095,-3.18321 4.67361,-3.758944 z m 61.46808,24.129794 c -0.98213,4.436532 -2.01478,7.670766 -3.09851,9.702766 -1.04987,2.032003 -1.99864,3.047873 -2.84531,3.047873 -0.508,0 -0.88018,-0.18609 -1.11724,-0.55862 -0.2032,-0.37253 -0.30489,-0.84692 -0.30489,-1.42265 0,-1.354669 0.57556,-2.929327 1.72702,-4.72426 1.15147,-1.794934 3.0312,-3.80991 5.63893,-6.045109 z"
				/>
			</svg>
		</div>
	</ClientOnly>
</template>

<script setup lang="ts">
import { ref, onMounted, nextTick } from "vue";
import gsap from "gsap";

const strokeWidth = 2;
const pathRef = ref<SVGPathElement | null>(null);
const overlayRef = ref<HTMLElement | null>(null);
const show = ref(true);

onMounted(async () => {
	await nextTick();
	const pathEl = pathRef.value;
	if (!pathEl) return;

	// Добавляем задержку для iOS Safari
	setTimeout(() => {
		try {
			const length = pathEl.getTotalLength();
			if (length && length > 0) {
				pathEl.style.strokeDasharray = `${length}`;
				pathEl.style.strokeDashoffset = `${length}`;
				pathEl.style.visibility = "visible";

				gsap.to(pathEl, {
					strokeDashoffset: 0,
					duration: 5,
					ease: "power1.inOut",
					onComplete() {
						const ov = overlayRef.value;
						if (ov) {
							gsap.to(ov, {
								opacity: 0,
								duration: 0.5,
								delay: 0.3,
								onComplete() {
									show.value = false;
								},
							});
						} else {
							show.value = false;
						}
					},
				});
			} else {
				// Fallback если getTotalLength не работает
				pathEl.style.visibility = "visible";
				setTimeout(() => {
					show.value = false;
				}, 2000);
			}
		} catch (error) {
			// Fallback для ошибок
			pathEl.style.visibility = "visible";
			setTimeout(() => {
				show.value = false;
			}, 2000);
		}
	}, 100);
});
</script>

<style scoped>
.preloader-overlay {
	position: fixed;
	top: 0;
	left: 0;
	width: 100vw;
	height: 100vh;
	display: flex;
	align-items: center;
	justify-content: center;
	background: #fff;
	z-index: 99999;
	opacity: 1;
}

.preloader-svg {
	width: 60%;
	height: auto;
	color: #000;
	visibility: hidden;
	overflow: visible;
	/* Принудительно включаем аппаратное ускорение для iOS */
	transform: translateZ(0);
	-webkit-transform: translateZ(0);

	@include tablet {
		width: 50%;
	}

	@include laptop {
		width: 40%;
	}

	@include desktop {
		width: 35%;
	}
}

/* Дополнительные стили для iOS Safari */
.preloader-svg path {
	transform: translateZ(0);
	-webkit-transform: translateZ(0);
}
</style>
